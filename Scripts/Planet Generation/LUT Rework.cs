using System;
using System.Collections.Generic;
using UnityEngine;

namespace GalacticScale
{
    public static partial class GS3
    {
        public static Dictionary<int, int[]> keyedLUTs = new();

        public static void SetLuts(int segments, float planetRadius)
        {
            if (!DSPGame.IsMenuDemo) // Prevent special LUT's being created in main menu
            {
                if (keyedLUTs.ContainsKey(segments) && Patches.PatchOnUIBuildingGrid.LUT512.ContainsKey(segments)) return;
                var numSegments = segments / 4; //Number of segments on a quarter circle (the other 3/4 will result by mirroring)
                var lut = new int[numSegments];
                var segmentAngle = Mathf.PI / 2f / numSegments; //quarter circle divided by num segments is the angle per segment

                var lastMajorRadius = planetRadius;
                var lastMajorRadiusCount = numSegments * 4;

                var classicLUT = new int[512];
                classicLUT[0] = 1;
                // GS3.Warn("Start");
                for (var cnt = 0; cnt < numSegments; cnt++)
                {
                    var ringradius = Mathf.Cos(cnt * segmentAngle) * planetRadius; //cos of the nth segment is the x-distance of the point in a 2d circle
                    var classicIdx = Mathf.CeilToInt(Mathf.Abs(Mathf.Cos((float)((cnt + 1) / (segments / 4f) * Math.PI * 0.5))) * segments);

                    //If the new radius is smaller than 90% of the currently used radius, use it as the new segment count to avoid tile squishing
                    if (ringradius < 0.9 * lastMajorRadius)
                    {
                        lastMajorRadius = ringradius;
                        lastMajorRadiusCount = (int)(ringradius / 4.0) * 4;
                    }

                    lut[cnt] = lastMajorRadiusCount;
                    // Log(classicIdx.ToString());
                    if (classicIdx >= classicLUT.Length) classicIdx = classicLUT.Length - 1;
                    classicLUT[classicIdx] = lastMajorRadiusCount;
                }

                // GS3.Warn("Mid");
                var last = 1;
                for (var oldlLutIdx = 1; oldlLutIdx < 512; oldlLutIdx++)
                    if (classicLUT[oldlLutIdx] > last)
                    {
                        //Offset of 1 is required to avoid mismatch of some longitude circles
                        var temp = classicLUT[oldlLutIdx];
                        classicLUT[oldlLutIdx] = last;
                        last = temp;
                    }
                    else
                    {
                        classicLUT[oldlLutIdx] = last;
                    }

                // Warn("End");
                if (segments == 200)
                {
                    lut = new[]
                    {
                        // 4, 8, 16, 20, 32, 32, 40, 40, 60, 60, 60, 80, 80, 80, 100, 100, 100, 100, 100, 120, 120, 120,
                        // 120, 120, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 200, 200, 200, 200, 200, 200, 200,
                        // 200, 200, 200, 200, 200, 200, 200, 200, 200

                        200, 200, 200, 200, 200, 200, 200,
                        200, 200, 200, 200, 200, 200, 200, 200, 200, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 120, 120,
                        120, 120, 120, 100, 100, 100, 100, 100, 80, 80, 80, 60, 60, 60, 40, 40, 32, 32, 20, 16, 8, 4
                    };
                    classicLUT = new int[512]
                    {
                        1,
                        4,
                        4,
                        4,
                        4,
                        4,
                        4,
                        4,
                        8,
                        8,
                        8,
                        8,
                        8,
                        8,
                        8,
                        8,
                        16,
                        16,
                        16,
                        16,
                        20,
                        20,
                        20,
                        20,
                        20,
                        20,
                        20,
                        20,
                        32,
                        32,
                        32,
                        32,
                        32,
                        32,
                        32,
                        32,
                        32,
                        32,
                        32,
                        32,
                        40,
                        40,
                        40,
                        40,
                        40,
                        40,
                        40,
                        40,
                        40,
                        40,
                        40,
                        40,
                        40,
                        40,
                        60,
                        60,
                        60,
                        60,
                        60,
                        60,
                        60,
                        60,
                        60,
                        60,
                        60,
                        60,
                        60,
                        60,
                        60,
                        60,
                        60,
                        60,
                        60,
                        80,
                        80,
                        80,
                        80,
                        80,
                        80,
                        80,
                        80,
                        80,
                        80,
                        80,
                        80,
                        80,
                        80,
                        80,
                        80,
                        80,
                        80,
                        100,
                        100,
                        100,
                        100,
                        100,
                        100,
                        100,
                        100,
                        100,
                        100,
                        100,
                        100,
                        100,
                        100,
                        100,
                        100,
                        100,
                        100,
                        100,
                        100,
                        100,
                        100,
                        100,
                        120,
                        120,
                        120,
                        120,
                        120,
                        120,
                        120,
                        120,
                        120,
                        120,
                        120,
                        120,
                        120,
                        120,
                        120,
                        120,
                        120,
                        120,
                        120,
                        120,
                        120,
                        120,
                        120,
                        120,
                        120,
                        120,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        160,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        200,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        240,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        300,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        400,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500,
                        500
                    };
                }

                //Fill all Look Up Tables (Dictionaries really)
                if (!keyedLUTs.ContainsKey(segments)) keyedLUTs.Add(segments, lut);
                if (!Patches.PatchOnUIBuildingGrid.LUT512.ContainsKey(segments)) Patches.PatchOnUIBuildingGrid.LUT512.Add(segments, classicLUT);
            }
        }
    }
}